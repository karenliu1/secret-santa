<html>
    <head>
        <title>Secret Santa!</title>
        <script src="https://cdn.firebase.com/js/client/2.3.1/firebase.js"></script>
        <script src="https://code.jquery.com/jquery-2.1.4.js"></script>
        <script type="text/javascript">
            var ref = new Firebase("https://scorching-inferno-8300.firebaseio.com/");

            function showUsersInRoom(roomName) {
                window.currentRoomName = roomName;
                window.currentRoomMembers = {};
                $('#assign-button').hide();
                $('#room-members').empty();
                var usersRef = ref.child(roomName).child('users')
                usersRef.on('child_added', function(userResponse) {
                    var userKey = userResponse.key();
                    var userName = userResponse.val();
                    window.currentRoomMembers[userKey] = userName;
                    $('#room-details').show();
                    $('#room-members').append('<span class="room-member">' + userName + '</span>');
                });

                ref.child(roomName).child('assignments').on('value', function(assignments) {
                    // If we have people in the room and we don't have assignments,
                    // show the assign button.
                    if (Object.keys(window.currentRoomMembers).length > 1 && !assignments.val()) {
                        $('#assign-button').show();
                    }

                    // If assignments exist, show the current user's assignment.
                    if (window.currentUserRef) {
                        var currentUserKey = window.currentUserRef.key();
                        var assignmentKey = assignments.val()[currentUserKey];

                        $('#assignment').show();
                        $('#assignment-name').text(window.currentRoomMembers[assignmentKey]);
                    }
                });
            }

            // http://stackoverflow.com/a/12646864
            function shuffleArray(array) {
                for (var i = array.length - 1; i > 0; i--) {
                    var j = Math.floor(Math.random() * (i + 1));
                    var temp = array[i];
                    array[i] = array[j];
                    array[j] = temp;
                }
                return array;
            }

            // Basically checks if anyone got themselves.
            function isValidShuffle(array1, array2) {
                for (var i = 0; i < array1.length; i++) {
                    if (array1[i] === array2[i]) {
                        return false;
                    }
                }
                return true;
            }

            $(function() {
                $("#room-form").submit(function(event) {
                    var roomName = $('#room-input').val();
                    showUsersInRoom(roomName);
                    return false;
                });

                $('#add-user-form').submit(function(event) {
                    var usersRef = ref.child(window.currentRoomName).child('users');
                    var userName = $('#user-name-input').val();
                    window.currentUserRef = usersRef.push(userName);
                    $('#add-user-form').slideUp('slow');
                    return false;
                });

                $('#assign-button').hover(function(event) {
                    $(this).find('#button-text').addClass('animated shake')
                }, function(event) {
                    $(this).find('#button-text').removeClass('animated shake')
                });

                $('#assign-button').click(function(event) {
                    var originalUsers = Object.keys(window.currentRoomMembers);
                    var shuffledUsers = originalUsers.slice(0);
                    do {
                        shuffleArray(shuffledUsers);
                    } while (!isValidShuffle(shuffledUsers, originalUsers));

                    var assignmentsRef = ref.child(window.currentRoomName).child('assignments');

                    var newAssignments = {};
                    for (var i = 0; i < shuffledUsers.length; i++) {
                        newAssignments[originalUsers[i]] = shuffledUsers[i];
                    }
                    assignmentsRef.set(newAssignments);

                    $('#assign-button').slideUp('slow');
                    return false;
                });

                // Hide most elements until a room is chosen
                $('#room-details').hide();
                $('#assign-button').hide();
                $('#assignment').hide();
            });
        </script>
        <link href='https://fonts.googleapis.com/css?family=Open+Sans' rel='stylesheet' type='text/css'>
        <link rel="stylesheet"
              href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.4.0/animate.min.css" />
        <link rel="stylesheet" href="button.css" />
        <link rel="stylesheet" href="styles.css" />
    </head>
    <body>
        <div class="content-container">
            <form id="room-form">
                <label>
                    <div><strong>What is the Secret Santa room name?</strong></div>
                    <input class="input" type="text" id="room-input" value="">
                </label>
                <button class="btn btn-1 btn-1e" type="submit">Go</button>
            </form>

            <div id="room-details">
                <div id="room-members-title">
                    <strong>In this room:</strong>
                </div>
                <div id="room-members"></div>
                <form id="add-user-form">
                    <label>
                        <div><strong>Who are you?</strong></div>
                        <input class="input" type="text" id="user-name-input" value="">
                    </label>
                    <button class="btn btn-1 btn-1e" type="submit">That's me</button>
                </form>

                <button id="assign-button" class="btn btn-1 btn-1e" type="submit">
                    <div id="button-text">Shake the hat</div>
                </button>
            </div>

            <div id="assignment">
                <strong>You are the Secret Santa for:</strong>
                <span class="room-member" id="assignment-name"></span>
            </div>
        </div>
    </body>
</html>
